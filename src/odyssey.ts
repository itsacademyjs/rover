/**
 * Copyright (c) AcademyJS and its affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */

import { Command } from "commander";
import chalk from "chalk";
import mongoose from "mongoose";
import { readFileSync } from "fs";
import dotenv from "dotenv";
import { SyncConfiguration } from "./types";
import { TestSuite } from "./models";

dotenv.config();
const { DATABASE_URL } = process.env;

const syncExercises = async (
    configuration: SyncConfiguration
): Promise<void> => {
    const file = configuration.file ?? "meta.json";
    const rawData = readFileSync(file);
    const data = JSON.parse(String(rawData)).suites[0].suites.map((suite) => ({
        title: suite.title,
        description: suite.description,
        handle: suite.handle,
        testCases: suite.tests.map((test) => ({
            title: test.title,
            description: test.description,
        })),
    }));
    const updateQueries = data.map((item) => ({
        updateOne: {
            filter: {
                handle: item.handle,
            },
            update: {
                $set: item,
            },
            upsert: true,
        },
    }));

    try {
        mongoose.connect(DATABASE_URL);
        await TestSuite.bulkWrite(updateQueries);
        console.log("Exercises synced");
    } catch (error) {
        console.log(error);
    } finally {
        mongoose.disconnect();
    }
};

const packageData = require("../../package");

const configureCommands = (): Command => {
    const program = new Command();
    program.version(packageData.version);

    const syncCommand = new Command();
    syncCommand
        .name("sync")
        .argument("[file]", "the json file generated by meta command", null)
        .alias("s")
        .description("sync exercises with the database")
        .action(async (file: string | null) => {
            const configuration = {
                file,
                ...program.opts(),
                ...syncCommand.opts(),
            } as SyncConfiguration;
            await syncExercises(configuration);
        });
    program.addCommand(syncCommand);

    return program;
};

const main = () => {
    console.log(
        chalk.bold(
            `odyssey ${packageData.version} ${chalk.greenBright(
                "(https://academyjs.com/odyssey)"
            )}`
        )
    );
    const program = configureCommands();
    program.parse(process.argv);
};

export { main };
